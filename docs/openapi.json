{
  "openapi": "3.0.0",
  "info": {
    "title": "Prediction Game API",
    "description": "API for wallet-authenticated prediction gameplay, leaderboards, rounds, and predictions. Use Swagger UI to explore endpoints and test requests.",
    "version": "1.0.0"
  },
  "servers": [
    {
      "url": "http://localhost:3000"
    }
  ],
  "tags": [
    { "name": "auth", "description": "Wallet authentication and JWT issuance" },
    { "name": "leaderboard", "description": "Leaderboard and rankings" },
    { "name": "rounds", "description": "Round management and resolution" },
    { "name": "predictions", "description": "Prediction placement and queries" },
    { "name": "education", "description": "Educational content" },
    { "name": "user", "description": "User profile & balance (planned)" }
  ],
  "paths": {
    "/api/auth/challenge": {
      "post": {
        "tags": ["auth"],
        "summary": "Request a wallet authentication challenge",
        "description": "Step 1 of wallet authentication. Returns a one-time challenge string for the wallet to sign.\n\nRate limit: 10 requests per 15 minutes per IP. On limit, responds with 429.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/AuthChallengeRequest" },
              "example": {
                "walletAddress": "GB3JDWCQWJ5VQJ3H6E6GQGZVFKU4ZQXGJ6S4Q2W7S6ZJ5R2YQH2B7ZQX"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Challenge created",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/AuthChallengeResponse" },
                "example": {
                  "challenge": "random-challenge-string",
                  "expiresAt": "2026-01-29T00:00:00.000Z"
                }
              }
            }
          },
          "400": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "examples": {
                  "missingWallet": {
                    "value": {
                      "error": "Validation Error",
                      "message": "walletAddress is required"
                    }
                  },
                  "invalidWallet": {
                    "value": {
                      "error": "Validation Error",
                      "message": "Invalid Stellar wallet address format"
                    }
                  }
                }
              }
            }
          },
          "429": {
            "description": "Too many requests",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/RateLimitResponse" }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "example": {
                  "error": "Internal Server Error",
                  "message": "Failed to generate authentication challenge"
                }
              }
            }
          }
        }
      }
    },
    "/api/auth/connect": {
      "post": {
        "tags": ["auth"],
        "summary": "Verify signature and authenticate wallet",
        "description": "Step 2 of wallet authentication. Verifies the signature for the challenge and returns a JWT.\n\nRate limit: 5 requests per 15 minutes per IP. On limit, responds with 429.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/AuthConnectRequest" },
              "example": {
                "walletAddress": "GB3JDWCQWJ5VQJ3H6E6GQGZVFKU4ZQXGJ6S4Q2W7S6ZJ5R2YQH2B7ZQX",
                "challenge": "random-challenge-string",
                "signature": "base64-or-hex-signature"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Authenticated",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/AuthConnectResponse" }
              }
            }
          },
          "400": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "example": {
                  "error": "Validation Error",
                  "message": "walletAddress, challenge, and signature are required"
                }
              }
            }
          },
          "401": {
            "description": "Authentication failed",
            "content": {
              "application/json": {
                "examples": {
                  "invalidSignature": {
                    "value": { "error": "Authentication Error", "message": "Invalid signature" }
                  },
                  "expiredChallenge": {
                    "value": {
                      "error": "Authentication Error",
                      "message": "Challenge has expired. Please request a new one."
                    }
                  }
                }
              }
            }
          },
          "429": {
            "description": "Too many requests",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/RateLimitResponse" }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "example": { "error": "Internal Server Error", "message": "Failed to authenticate wallet" }
              }
            }
          }
        }
      }
    },
    "/api/leaderboard": {
      "get": {
        "tags": ["leaderboard"],
        "summary": "Get the global leaderboard",
        "description": "Returns the global leaderboard. Bearer authentication is optional; if provided, the API may include the requesting user's position.\n\nQuery params support pagination.",
        "parameters": [
          {
            "in": "query",
            "name": "limit",
            "schema": { "type": "integer", "minimum": 1, "maximum": 500, "default": 100 },
            "description": "Max number of entries to return (max 500)"
          },
          {
            "in": "query",
            "name": "offset",
            "schema": { "type": "integer", "minimum": 0, "default": 0 },
            "description": "Pagination offset"
          }
        ],
        "responses": {
          "200": {
            "description": "Leaderboard payload",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/LeaderboardResponse" }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "example": { "error": "Internal Server Error", "message": "Failed to fetch leaderboard" }
              }
            }
          }
        }
      }
    },
    "/api/rounds/start": {
      "post": {
        "tags": ["rounds"],
        "summary": "Start a new prediction round",
        "description": "Admin-only. Starts a new round for a given mode, start price, and duration.",
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "mode": { "type": "integer", "enum": [0, 1], "description": "0 (UP_DOWN) or 1 (LEGENDS)" },
                  "startPrice": { "type": "number", "description": "Starting price (must be > 0)" },
                  "duration": { "type": "integer", "description": "Duration in seconds (must be > 0)" }
                },
                "required": ["mode", "startPrice", "duration"]
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Round started" },
          "400": { "description": "Validation error" },
          "401": { "description": "Unauthorized" },
          "403": { "description": "Forbidden (admin role required)" },
          "500": { "description": "Internal server error" }
        }
      }
    },
    "/api/rounds/{id}": {
      "get": {
        "tags": ["rounds"],
        "summary": "Get a round by ID",
        "parameters": [
          { "in": "path", "name": "id", "required": true, "schema": { "type": "string" }, "description": "Round ID" }
        ],
        "responses": {
          "200": { "description": "Round found" },
          "404": { "description": "Round not found" },
          "500": { "description": "Internal server error" }
        }
      }
    },
    "/api/rounds/active": {
      "get": {
        "tags": ["rounds"],
        "summary": "Get active rounds",
        "responses": { "200": { "description": "Active rounds" }, "500": { "description": "Internal server error" } }
      }
    },
    "/api/rounds/{id}/resolve": {
      "post": {
        "tags": ["rounds"],
        "summary": "Resolve a round with the final price",
        "description": "Oracle-only (or Admin). Resolves the round and computes winners.",
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "in": "path", "name": "id", "required": true, "schema": { "type": "string" }, "description": "Round ID" }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": { "finalPrice": { "type": "number", "description": "Final price (must be > 0)" } },
                "required": ["finalPrice"]
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Round resolved" },
          "400": { "description": "Validation error" },
          "401": { "description": "Unauthorized" },
          "403": { "description": "Forbidden (oracle/admin required)" },
          "500": { "description": "Internal server error" }
        }
      }
    },
    "/api/predictions/submit": {
      "post": {
        "tags": ["predictions"],
        "summary": "Submit a prediction for a round",
        "description": "Authenticated users only.",
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "roundId": { "type": "string" },
                  "userId": { "type": "string" },
                  "amount": { "type": "number" },
                  "side": { "type": "string" },
                  "priceRange": { "type": "string" }
                },
                "required": ["roundId", "userId", "amount"]
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Prediction submitted" },
          "400": { "description": "Validation error" },
          "401": { "description": "Unauthorized" },
          "500": { "description": "Internal server error" }
        }
      }
    },
    "/api/predictions/user/{userId}": {
      "get": {
        "tags": ["predictions"],
        "summary": "Get all predictions for a user",
        "parameters": [
          { "in": "path", "name": "userId", "required": true, "schema": { "type": "string" }, "description": "User ID" }
        ],
        "responses": { "200": { "description": "Predictions list" }, "500": { "description": "Internal server error" } }
      }
    },
    "/api/predictions/round/{roundId}": {
      "get": {
        "tags": ["predictions"],
        "summary": "Get all predictions for a round",
        "parameters": [
          { "in": "path", "name": "roundId", "required": true, "schema": { "type": "string" }, "description": "Round ID" }
        ],
        "responses": { "200": { "description": "Predictions list" }, "500": { "description": "Internal server error" } }
      }
    },
    "/api/education/guides": {
      "get": {
        "tags": ["education"],
        "summary": "Get educational guides",
        "description": "Returns a structured list of static educational guides grouped by category.",
        "responses": { "200": { "description": "Education guides" }, "500": { "description": "Internal server error" } }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Paste a JWT like: Bearer <token>"
      }
    },
    "schemas": {
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "error": { "type": "string" },
          "message": { "type": "string" }
        },
        "required": ["error"],
        "additionalProperties": true
      },
      "RateLimitResponse": {
        "allOf": [{ "$ref": "#/components/schemas/ErrorResponse" }],
        "example": {
          "error": "Too Many Requests",
          "message": "Too many requests from this IP, please try again after 15 minutes"
        }
      },
      "AuthChallengeRequest": {
        "type": "object",
        "properties": {
          "walletAddress": {
            "type": "string",
            "description": "Stellar wallet public key (G...)"
          }
        },
        "required": ["walletAddress"],
        "additionalProperties": false
      },
      "AuthChallengeResponse": {
        "type": "object",
        "properties": {
          "challenge": { "type": "string" },
          "expiresAt": { "type": "string", "format": "date-time" }
        },
        "required": ["challenge", "expiresAt"],
        "additionalProperties": false
      },
      "AuthConnectRequest": {
        "type": "object",
        "properties": {
          "walletAddress": { "type": "string" },
          "challenge": { "type": "string" },
          "signature": { "type": "string" }
        },
        "required": ["walletAddress", "challenge", "signature"],
        "additionalProperties": false
      },
      "AuthConnectResponse": {
        "type": "object",
        "properties": {
          "token": { "type": "string" },
          "user": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "walletAddress": { "type": "string" },
              "createdAt": { "type": "string", "format": "date-time" },
              "lastLoginAt": { "type": "string", "format": "date-time" }
            },
            "required": ["id", "walletAddress", "createdAt", "lastLoginAt"],
            "additionalProperties": true
          }
        },
        "required": ["token", "user"],
        "additionalProperties": false
      },
      "LeaderboardResponse": {
        "type": "object",
        "properties": {
          "leaderboard": { "type": "array", "items": { "type": "object" } },
          "userPosition": { "type": "object", "nullable": true },
          "totalUsers": { "type": "number" },
          "lastUpdated": { "type": "string" }
        },
        "required": ["leaderboard", "totalUsers", "lastUpdated"],
        "additionalProperties": true
      }
    }
  }
}

